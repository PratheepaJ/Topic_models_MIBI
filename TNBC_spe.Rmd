---
title: "Untitled"
output: html_document
date: "2022-10-28"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
```

## Apply package spatialExperiment to TNBC
```{r}
library(SpatialExperiment)


example("read10xVisium", echo = FALSE)
spe
```

Read in the TNBC dataset,
```{r}
TNBC <- read.csv("/Users/henzhwang/Desktop/TNBC_training/MIBI-TNBC_scdata_counts_mm_matlab_revised.csv")
```


### Construct Spatial experiment object for TNBC dataset

We want to construct the spatial experiment object for TNBC dataset following [http://www.bioconductor.org/packages/release/bioc/vignettes/SpatialExperiment/inst/doc/SpatialExperiment.html#2_Object_construction](http://www.bioconductor.org/packages/release/bioc/vignettes/SpatialExperiment/inst/doc/SpatialExperiment.html#2_Object_construction)

```{r}
# We want to construct a spatial experiment object obtainning rowData, assays, colData and SpatialCoord first

# rowData: metadata of the TNBC dataset
# metadata column: names(TNBC)[, 2:9]
# rowData <- TNBC %>% 
#   select(c(names(TNBC)[, 2:9]))

rowData <-TNBC %>% 
  select(c("patient_id", "AGE_AT_DX", "STAGE", "SITE_02", "LATERAL", "GRADE", "RECURRENCE_LABEL", "Survival_days_capped"))

# assays
assays <- TNBC %>%
  select(-c("patient_id", "AGE_AT_DX", "STAGE", "SITE_02", "LATERAL", "GRADE", "RECURRENCE_LABEL", "Survival_days_capped"))

# colData
colData <- TNBC %>% 
  select(c("sample_id", "cluster_id", "mm", "cell_type", "ImageNb", "cellLabelInImage", "cellSize", "cellRadius", "centroidX", "centroidY", "majoraxis"))

# spatialCoordsNames
spatialCoordsNames <- c("centroidX", "centroidY")
```


We then want to construct the spatial experiment object

```{r}
spe_TNBC1 <- SpatialExperiment(
  assays = list(counts = assays),
  rowData = rowData,
  colData = colData,
  spatialCoordsNames = spatialCoordsNames
)
```

Try with using the raw data with the fcs files,

```{r}
library(readxl)
library(flowCore)
library(CATALYST)

# read the raw data
md <- read_excel("/Users/henzhwang/Desktop/TNBC_training/metadata/TNBC_metadata.xlsx")
panel <- read_excel("/Users/henzhwang/Desktop/TNBC_training/metadata/TNBC_panel.xlsx")
fs <- read.flowSet(path = "/Users/henzhwang/Desktop/TNBC_training/data/CATALYST/FCS-catalyst",  
                   transformation = FALSE,      
                   truncate_max_range = FALSE)

# create sce object
sce <- prepData(fs, panel, md,
                md_cols = list(file = "file_name", id = "sample_id",  
                               factors = c("patient_id",  ###GUI these
                                           "AGE_AT_DX",
                                           "STAGE",
                                           "SITE_02",
                                           "LATERAL",
                                           "GRADE",
                                           "RECURRENCE_LABEL",
                                           "Survival_days_capped"
                                           
)), 
                transform = FALSE, ## !!N.B.<- when this is true, the transformed data goes to "exprs"
               #cofactor = 5,
                FACS = TRUE,
                by_time=FALSE)
```


Then checking the sce object
```{r}
# sce object
sce

#assays of the sce object
#assay(sce)
rowData(sce)
colData(sce)
```

Then following steps of spatial experiment, we want to create a spatial experiment object
```{r}

# col <- read.csv("/Users/henzhwang/Desktop/TNBC_training/MIBI-TNBC_scdata_counts_mm_matlab_revised.csv",
#                 #header = FALSE, 
#                 col.names = c("sample_id", "cluster_id", "mm", "cell_type", "ImageNb", "cellLabelInImage", "cellSize", "cellRadius", "centroidX", "centroidY", "majoraxis"))

spe_TNBC1 <- SpatialExperiment(
  assays = list(counts = assay(sce)),
  rowData = rowData(sce),
  #coldata = colData(sce),
  colData = DataFrame(col),
  spatialCoordsNames = c("centroidX, centroidY")
)
spe_TNBC1
```




SpatialExperiement takes few arguments,
 - assay
    Tables of measurements values such as raw and transformed transcripts counts (features and columns to observations)
 - rowData
    Additional information (metadata) describing the features (eg. genes ID and names)
 - colData
    - metadata describing the observations (eg. cell IDs)
    - describing spatial characterstics of the spatial coordinates(spots) or cells (e.g. indicators for whether spots are located within the region overlapping with tissue)
 - spatialCoords
    Spatial coordinates associated with each observations (eg. x, y coordintates on the tissue slides)
 - imgData
    Images files and information related to the images(eg. resolution of the images)


Thus, for the TNBC dataset, we would have:
assay = 